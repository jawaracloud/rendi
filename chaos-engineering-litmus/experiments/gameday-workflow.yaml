apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: gameday-cascading-failure
  namespace: litmus
spec:
  entrypoint: chaos-sequence
  serviceAccountName: litmus-admin
  templates:
    - name: chaos-sequence
      steps:
        - - name: network-degradation
            template: network-latency
        - - name: database-stress
            template: cpu-hog-db
        - - name: pod-failures
            template: pod-delete-frontend
        - - name: verification
            template: system-verification
    
    - name: network-latency
      container:
        image: litmuschaos/litmus-checker:latest
        command: [sh, -c]
        args:
          - |
            echo "Injecting network latency..."
            kubectl apply -f /tmp/network-latency.yaml
            kubectl wait --for=condition=Completed chaosengine/api-network-latency -n litmus --timeout=300s
            echo "Network latency experiment completed"
        volumeMounts:
          - name: experiment-yamls
            mountPath: /tmp
    
    - name: cpu-hog-db
      container:
        image: litmuschaos/litmus-checker:latest
        command: [sh, -c]
        args:
          - |
            echo "Injecting CPU stress on database..."
            kubectl apply -f /tmp/cpu-hog-db.yaml
            kubectl wait --for=condition=Completed chaosengine/db-cpu-hog -n litmus --timeout=300s
            echo "CPU stress experiment completed"
        volumeMounts:
          - name: experiment-yamls
            mountPath: /tmp
    
    - name: pod-delete-frontend
      container:
        image: litmuschaos/litmus-checker:latest
        command: [sh, -c]
        args:
          - |
            echo "Injecting pod failures..."
            kubectl apply -f /tmp/pod-delete.yaml
            kubectl wait --for=condition=Completed chaosengine/frontend-pod-delete -n litmus --timeout=300s
            echo "Pod delete experiment completed"
        volumeMounts:
          - name: experiment-yamls
            mountPath: /tmp
    
    - name: system-verification
      container:
        image: bitnami/kubectl:latest
        command: [sh, -c]
        args:
          - |
            echo "Verifying system health..."
            kubectl get pods -n default
            kubectl top pods -n default
            echo "System verification completed"
  
  volumes:
    - name: experiment-yamls
      configMap:
        name: chaos-experiments
